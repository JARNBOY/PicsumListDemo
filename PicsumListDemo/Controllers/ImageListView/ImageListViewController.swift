//
//  ImageListViewController.swift
//  PicsumListDemo
//
//  Created by Papon Supamongkonchai on 24/4/2566 BE.
//  Copyright (c) 2566 BE ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol ImageListDisplayLogic: AnyObject
{
    func displayGetImagesPicsum(viewModel: ImageList.FetchImageURL.ViewModel)
    func displayLoadImage(viewModel: ImageList.GetImage.ViewModel)
}

class ImageListViewController: UIViewController, ImageListDisplayLogic
{
    @IBOutlet weak var imagesCollectionView: UICollectionView!
    
    var interactor: ImageListBusinessLogic?
    var router: (NSObjectProtocol & ImageListRoutingLogic & ImageListDataPassing)?
    
    private var loadedImageList: [URL] = []
    
    // MARK: Object lifecycle
    override func awakeFromNib() {
        super.awakeFromNib()
        setup()
    }
    
    // MARK: View lifecycle
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupView()
        getImagesPicsum()
    }
    
    // MARK: Setup
    private func setup() {
        let viewController = self
        let interactor = ImageListInteractor()
        let presenter = ImageListPresenter()
        let router = ImageListRouter()
        viewController.interactor = interactor
        viewController.router = router
        interactor.presenter = presenter
        presenter.viewController = viewController
        router.viewController = viewController
        router.dataStore = interactor
    }
    
    //MARK: View
    private func setupView() {
        imagesCollectionView.delegate = self
        imagesCollectionView.dataSource = self
        imagesCollectionView.prefetchDataSource = self
        
        let nib = UINib(nibName: "ImageViewCell", bundle: nil)
        imagesCollectionView.register(nib, forCellWithReuseIdentifier: "ImageViewCell")
        
    }
    
    // MARK: Function
    func getImagesPicsum() {
        interactor?.fetchImagesPicsum()
    }
    
    // MARK: ImageListDisplayLogic
    func displayGetImagesPicsum(viewModel: ImageList.FetchImageURL.ViewModel) {
        // Load a batch of images starting from the given index
        self.loadedImageList = viewModel.urls.compactMap({ URL(string: $0)})
        imagesCollectionView.reloadData()
    }
    
    func displayLoadImage(viewModel: ImageList.GetImage.ViewModel) {
        let indexPath = IndexPath(item: viewModel.rowUpdate, section: 0)
        imagesCollectionView.reloadItems(at: [indexPath])
    }
}


extension ImageListViewController: UICollectionViewDelegate, UICollectionViewDataSource, UICollectionViewDelegateFlowLayout, UICollectionViewDataSourcePrefetching {
    func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        return loadedImageList.count
    }
    
    func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        let cell = collectionView.dequeueReusableCell(withReuseIdentifier: "ImageViewCell", for: indexPath) as! ImageViewCell
        if let imageData = ImageLoaderManager.shared.imageDataCache[loadedImageList[indexPath.row]] {
            cell.setImageCache(img: UIImage(data: imageData))
        } else {
            cell.configureCell(imageUrl: loadedImageList[indexPath.row])
        }
        
        return cell
    }
    
    func collectionView(_ collectionView: UICollectionView, prefetchItemsAt indexPaths: [IndexPath]) {
        // Prefetch image data for the specified indexPaths
        let prefetchUrls = indexPaths.compactMap { indexPath in
            return loadedImageList[indexPath.row]
        }
        ImageLoaderManager.shared.prefetchImageUrls(prefetchUrls)
    }
    
    func collectionView(_ collectionView: UICollectionView, willDisplay cell: UICollectionViewCell, forItemAt indexPath: IndexPath) {
        cell.fadeAnimation()
    }
    
    func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout, sizeForItemAt indexPath: IndexPath) -> CGSize {
        let width = self.view.bounds.width
        let height = CGFloat(300)
        return CGSize(width: width, height: height)
    }
}
